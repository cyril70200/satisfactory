<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Select Item</title>
    <link rel="stylesheet" href="/static/style.css">
    <script>
    function filterItems() {
        var input = document.getElementById('searchBox').value.toLowerCase();
        var select = document.getElementById('item');
        for (var i = 0; i < select.options.length; i++) {
            var option = select.options[i];
            var text = option.text.toLowerCase();
            if (text.includes(input)) {
                option.style.display = '';
            } else {
                option.style.display = 'none';
            }
        }
        // If nothing matches, clear selection
        var anyVisible = false;
        for (var i = 0; i < select.options.length; i++) {
            if (select.options[i].style.display !== 'none') {
                select.selectedIndex = i;
                anyVisible = true;
                break;
            }
        }
        if (!anyVisible) {
            select.selectedIndex = -1;
        }
    }
    </script>
</head>
<body>
    {% extends "layout.html" %}
    {% import "card.html" as card_macros %}
    {% block content %}
    <div class="row align-items-center g-2 mb-1" style="margin-top:8px;">
      <div class="col-auto fw-bold" style="font-size:1.1em;">Calculator:</div>
      <div class="col">
        <input type="text" id="calc-input" class="form-control" placeholder="Type an operation, e.g. (240+120)*12/3" onkeydown="if(event.key==='Enter'){calculateExpression();}">
      </div>
      <div class="col-auto">
        <button class="btn btn-primary" onclick="calculateExpression()">Calc</button>
      </div>
    </div>
    <div class="row mb-3">
      <div class="col">
        <div id="calc-result" class="fw-bold text-primary" style="font-size:1.1em;"></div>
      </div>
    </div>
    <div class="container-fluid my-4">
      <div class="row">
        <!-- Main card tree column: show all item trees if any -->
        <div class="col-12">
          {% if project_items %}
            <div class="row">
              {% for item in project_items %}
                <div class="col-md-12 mb-4">
                  <h5 class="mb-2">
                    <span class="{{ 'text-secondary' if item.card and item.card.outsource else '' }}">{{ item.name }}</span>
                    <span class="badge bg-primary">{{ item.rate }}/min</span>
                    {% if not item.has_recipe %}
                      <a href="{{ url_for('select_recipe', item_id=item.item) }}" class="btn btn-sm btn-outline-primary ms-2">Select Recipe</a>
                    {% endif %}
                  </h5>
                  {% if item.card %}
                    {% if item.card.outsource %}
                      {{ card_macros.outsource_card(item.card, get_machine_name=get_machine_name, recipes=recipes) }}
                    {% else %}
                      {{ card_macros.render_card(item.card, True, True, recipes=recipes, get_item_name=get_item_name, get_machine_name=get_machine_name) }}
                    {% endif %}
                  {% else %}
                    <div class="alert alert-info">No recipe selected for this item yet.</div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="alert alert-secondary text-center">No items in this project yet. Use the left bar to add items.</div>
          {% endif %}
        </div>
      </div>
      <!-- Right-side summary is now in layout.html -->
    </div>
    {% endblock %}

    {% block scripts %}
    <script>
    function calculateExpression() {
      const input = document.getElementById('calc-input').value;
      const resultDiv = document.getElementById('calc-result');
      if (!input.trim()) {
        resultDiv.textContent = '';
        return;
      }
      try {
        // Only allow numbers, operators, parentheses, decimal points, and spaces
        if (/^[0-9+\-*/().\s]+$/.test(input)) {
          // eslint-disable-next-line no-eval
          const result = eval(input);
          resultDiv.textContent = '= ' + result;
        } else {
          resultDiv.textContent = 'Invalid characters';
        }
      } catch (e) {
        resultDiv.textContent = 'Error';
      }
    }
    </script>
    {% endblock %}
</body>
</html>
